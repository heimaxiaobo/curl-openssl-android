name: build protobuf arm64-v8a

on:
  push:
    branches: [ master ]
  workflow_dispatch:

# 全局环境变量
env:
  PROTOBUF_VERSION: 3.19.4
  ANDROID_NDK_VERSION: r28c
  WORK_PATH: ${{github.workspace}}
  ANDROID_ABI: arm64-v8a
  ANDROID_PLATFORM: android-21 # 选择 21，兼容现代 NDK 与多数设备
  DEBUG: 1

permissions:
  contents: write

jobs:
  compile_protobuf_arm64_v8a:
    name: compile protobuf for arm64-v8a
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: 'Install required tools (aria2/cmake/ninja)'
        run: |
          set -e
          sudo apt -yqq update
          sudo apt install -yqq aria2 cmake ninja-build
          echo "[INFO] 基础工具安装完成: aria2, cmake, ninja"

      - name: 'Download Android NDK'
        id: download_ndk
        run: |
          set -e
          echo "[INFO] 下载 Android NDK: ${{env.ANDROID_NDK_VERSION}}"
          aria2c https://dl.google.com/android/repository/android-ndk-${{env.ANDROID_NDK_VERSION}}-linux.zip
          unzip android-ndk-${{env.ANDROID_NDK_VERSION}}-linux.zip
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 'Download Protobuf sources (v${{env.PROTOBUF_VERSION}})'
        id: download_protobuf
        run: |
          set -e
          echo "[INFO] 下载 Protobuf 源码: v${{env.PROTOBUF_VERSION}}"
          # 使用 GitHub 源代码归档（3.19.4 的 CMakeLists.txt 位于 cmake/ 子目录），并固定输出文件名避免重定向导致文件名不一致
          aria2c -o protobuf-${{env.PROTOBUF_VERSION}}.tar.gz https://github.com/protocolbuffers/protobuf/archive/refs/tags/v${{env.PROTOBUF_VERSION}}.tar.gz
          tar -zxvf protobuf-${{env.PROTOBUF_VERSION}}.tar.gz
          # 解压后目录通常为 protobuf-${{env.PROTOBUF_VERSION}}
          if [ ! -d "${{env.WORK_PATH}}/protobuf-${{env.PROTOBUF_VERSION}}" ]; then
            echo "[ERROR] 未找到解压后的源码目录 protobuf-${{env.PROTOBUF_VERSION}}"; ls -al; exit 1;
          fi
          # 3.19.4 的 CMakeLists.txt 位于 cmake/ 子目录，提前校验存在性
          if [ ! -f "${{env.WORK_PATH}}/protobuf-${{env.PROTOBUF_VERSION}}/cmake/CMakeLists.txt" ]; then
            echo "[ERROR] 缺少 cmake/CMakeLists.txt，无法使用 CMake 构建"; ls -al "${{env.WORK_PATH}}/protobuf-${{env.PROTOBUF_VERSION}}/cmake" || true; exit 1;
          fi
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 'Configure & Build Protobuf (CMake+Ninja)'
        id: build
        if: steps.download_ndk.outputs.status == 'success' && steps.download_protobuf.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          # 设置 NDK 路径与关键环境变量
          export NDK_HOME="${{env.WORK_PATH}}/android-ndk-${{env.ANDROID_NDK_VERSION}}"
          export ANDROID_TOOLCHAIN_FILE="$NDK_HOME/build/cmake/android.toolchain.cmake"
          echo "[INFO] NDK_HOME: $NDK_HOME"
          echo "[INFO] 使用 CMake toolchain: $ANDROID_TOOLCHAIN_FILE"

          SRC_DIR="${{env.WORK_PATH}}/protobuf-${{env.PROTOBUF_VERSION}}"
          CMAKESRC_DIR="$SRC_DIR/cmake" # 3.19.4 的 CMakeLists.txt 位于 cmake/ 子目录
          BUILD_DIR="${{env.WORK_PATH}}/protobuf-build-${{env.ANDROID_ABI}}"
          INSTALL_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}"
          mkdir -p "$BUILD_DIR" "$INSTALL_DIR"
          test -f "$CMAKESRC_DIR/CMakeLists.txt" || { echo "[ERROR] 未找到 $CMAKESRC_DIR/CMakeLists.txt"; ls -al "$CMAKESRC_DIR"; exit 1; }

          echo "[INFO] CMake 配置阶段（目标 ABI: ${{env.ANDROID_ABI}} / 平台: ${{env.ANDROID_PLATFORM}}）"
          cmake -G Ninja -S "$CMAKESRC_DIR" -B "$BUILD_DIR" \
            -DCMAKE_TOOLCHAIN_FILE="$ANDROID_TOOLCHAIN_FILE" \
            -DANDROID_ABI="${{env.ANDROID_ABI}}" \
            -DANDROID_PLATFORM="${{env.ANDROID_PLATFORM}}" \
            -DANDROID_STL="c++_static" \
            -Dprotobuf_BUILD_TESTS=OFF \
            -Dprotobuf_BUILD_PROTOC_BINARIES=OFF \
            -Dprotobuf_BUILD_CONFORMANCE=OFF \
            -Dprotobuf_BUILD_SHARED_LIBS=ON \
            -DBUILD_SHARED_LIBS=ON \
            -Dprotobuf_BUILD_EXAMPLES=OFF \
            -Dprotobuf_ABSL_PROVIDER=none \
            -Dprotobuf_WITH_ZLIB=OFF \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_INCLUDEDIR=include \
            -DCMAKE_INSTALL_LIBDIR=lib \
            -DCMAKE_C_FLAGS="-Os -fPIC -fstack-protector-strong -D_FORTIFY_SOURCE=2 -ffunction-sections -fdata-sections -fno-unwind-tables -fno-asynchronous-unwind-tables -flto" \
            -DCMAKE_CXX_FLAGS="-Os -fPIC -fstack-protector-strong -D_FORTIFY_SOURCE=2 -ffunction-sections -fdata-sections -fno-unwind-tables -fno-asynchronous-unwind-tables -flto" \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,--gc-sections -Wl,--strip-debug" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,--gc-sections -Wl,--strip-debug" \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON

          echo "[INFO] 开始编译（Release）"
          cmake --build "$BUILD_DIR" --config Release -j"$(nproc)"

          echo "[INFO] 安装到: $INSTALL_DIR"
          cmake --install "$BUILD_DIR" --prefix "$INSTALL_DIR"
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 'Verify build products'
        id: verify
        if: steps.build.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          echo "[INFO] 校验 Protobuf 构建产物（libprotobuf.so 或 libprotobuf-lite.so）"
          LIB_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}/lib"
          test -d "$LIB_DIR" || { echo "[ERROR] 缺少 lib 目录: $LIB_DIR"; exit 1; }
          if [ ! -f "$LIB_DIR/libprotobuf.so" ] && [ ! -f "$LIB_DIR/libprotobuf-lite.so" ]; then
            echo "[ERROR] 未找到 libprotobuf(.so) 或 libprotobuf-lite(.so)"; ls -al "$LIB_DIR"; exit 1;
          fi
          echo "[INFO] 构建产物校验通过"
          echo "status=success" >> $GITHUB_OUTPUT

      # 体积测量（strip 前）
      - name: 'Size report (before strip)'
        id: size_before
        if: steps.verify.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          LIB_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}/lib"
          echo "[INFO] Strip 前大小："
          ls -lh "$LIB_DIR" || true
          pre_lite_size_bytes=""; pre_full_size_bytes=""
          if [ -f "$LIB_DIR/libprotobuf-lite.so" ]; then pre_lite_size_bytes=$(stat -c %s "$LIB_DIR/libprotobuf-lite.so"); fi
          if [ -f "$LIB_DIR/libprotobuf.so" ]; then pre_full_size_bytes=$(stat -c %s "$LIB_DIR/libprotobuf.so"); fi
          echo "pre_lite_size_bytes=$pre_lite_size_bytes" >> $GITHUB_OUTPUT
          echo "pre_full_size_bytes=$pre_full_size_bytes" >> $GITHUB_OUTPUT

      # 使用 NDK 的 llvm-strip 去除调试符号/未用符号
      - name: 'Strip libraries (llvm-strip)'
        id: strip
        if: steps.verify.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          export NDK_HOME="${{env.WORK_PATH}}/android-ndk-${{env.ANDROID_NDK_VERSION}}"
          STRIP="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-strip"
          LIB_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}/lib"
          test -x "$STRIP" || { echo "[ERROR] 未找到 llvm-strip: $STRIP"; exit 1; }
          for so in libprotobuf-lite.so libprotobuf.so; do
            if [ -f "$LIB_DIR/$so" ]; then
              echo "[INFO] Stripping $so"
              "$STRIP" --strip-debug --strip-unneeded "$LIB_DIR/$so" || true
            fi
          done
          echo "status=success" >> $GITHUB_OUTPUT

      # 体积测量（strip 后）
      - name: 'Size report (after strip)'
        id: size_after
        if: steps.strip.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          LIB_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}/lib"
          echo "[INFO] Strip 后大小："
          ls -lh "$LIB_DIR" || true
          post_lite_size_bytes=""; post_full_size_bytes=""
          if [ -f "$LIB_DIR/libprotobuf-lite.so" ]; then post_lite_size_bytes=$(stat -c %s "$LIB_DIR/libprotobuf-lite.so"); fi
          if [ -f "$LIB_DIR/libprotobuf.so" ]; then post_full_size_bytes=$(stat -c %s "$LIB_DIR/libprotobuf.so"); fi
          echo "post_lite_size_bytes=$post_lite_size_bytes" >> $GITHUB_OUTPUT
          echo "post_full_size_bytes=$post_full_size_bytes" >> $GITHUB_OUTPUT

      # 符号完整性校验（确保核心 API 仍可用）
      - name: 'Symbol sanity check'
        id: symcheck
        if: steps.size_after.outputs.post_lite_size_bytes != '' || steps.size_after.outputs.post_full_size_bytes != ''
        run: |
          set -e
          export NDK_HOME="${{env.WORK_PATH}}/android-ndk-${{env.ANDROID_NDK_VERSION}}"
          NM="$NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-nm"
          LIB_DIR="${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}}/lib"
          test -x "$NM" || { echo "[ERROR] 未找到 llvm-nm: $NM"; exit 1; }
          if [ -f "$LIB_DIR/libprotobuf-lite.so" ]; then
            echo "[INFO] 校验 libprotobuf-lite.so 关键符号"
            "$NM" -D -C "$LIB_DIR/libprotobuf-lite.so" | grep -q "MessageLite::SerializeToString" || { echo "[ERROR] 缺少 MessageLite::SerializeToString，可能影响序列化功能"; exit 1; }
          fi
          if [ -f "$LIB_DIR/libprotobuf.so" ]; then
            echo "[INFO] 校验 libprotobuf.so 关键符号"
            "$NM" -D -C "$LIB_DIR/libprotobuf.so" | grep -q "DescriptorPool::FindMessageTypeByName" || { echo "[ERROR] 缺少 DescriptorPool::FindMessageTypeByName，可能影响反射/描述符功能"; exit 1; }
          fi
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 'Generate tar-zip'
        id: ziptar
        if: steps.symcheck.outputs.status == 'success' && !cancelled()
        run: |
          set -e
          echo "[INFO] 仅打包必要目录（lib/include），避免空包或冗余文件"
          tar -zcvf protobuf-${{env.PROTOBUF_VERSION}}-${{env.ANDROID_ABI}}.tar.gz \
            -C ${{env.WORK_PATH}}/build/protobuf-${{env.PROTOBUF_VERSION}}/${{env.ANDROID_ABI}} lib include
          echo "status=success" >> $GITHUB_OUTPUT

      - name: 'Upload zips to release'
        if: steps.ziptar.outputs.status == 'success' && !cancelled()
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{env.PROTOBUF_VERSION}}-protobuf-${{env.ANDROID_ABI}}
          body: "* Protobuf used - v${{env.PROTOBUF_VERSION}}\n* NDK used - ${{env.ANDROID_NDK_VERSION}}\n* ABI - ${{env.ANDROID_ABI}}\n\nSize Report (bytes):\n- lite: before=${{steps.size_before.outputs.pre_lite_size_bytes}} after=${{steps.size_after.outputs.post_lite_size_bytes}}\n- full: before=${{steps.size_before.outputs.pre_full_size_bytes}} after=${{steps.size_after.outputs.post_full_size_bytes}}\n\nBuild flags: -Os, -ffunction-sections/-fdata-sections, LTO, gc-sections, strip-debug, zlib OFF, ANDROID_STL=c++_static\nVerification: dynamic symbols checked (SerializeToString / FindMessageTypeByName)"
          files: |
            ${{env.WORK_PATH}}/protobuf-${{env.PROTOBUF_VERSION}}-${{env.ANDROID_ABI}}.tar.gz

      # 说明：
      # 本工作流针对体积优化进行了如下处理：
      # 1) 编译优化级别改为 -Os，并开启 LTO（CMAKE_INTERPROCEDURAL_OPTIMIZATION=ON / -flto）。
      # 2) 使用函数/数据分节并在链接时进行垃圾回收（--gc-sections）。
      # 3) 禁用 zlib 依赖（protobuf_WITH_ZLIB=OFF），减少链接体积。
      # 4) 使用 llvm-strip 去除调试符号与未用符号（--strip-debug/--strip-unneeded）。
      # 5) 增加 strip 前/后体积测量，并在 Release 说明中记录结果，便于回归对比。
      # 6) 改为静态 C++ 运行时（ANDROID_STL=c++_static），消除对 libc++_shared.so 的运行时依赖，便于 APP 直接加载。